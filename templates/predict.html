{% extends 'base.html' %}
{% set active_page = "predict" %}

<!--Title-->
{% block title %}
Sien Long's Data Science Web App
{% endblock %}


<!--Main content-->
{% block content %}
<div class="container">
  <h3 id="predict_output"></h3>
  <h3>Fill in the info to do a prediction of current resale price</h3>
  
  {% set towns = ['Ang Mo Kio', 'Bedok', 'Bishan', 'Bukit Batok', 'Bukit Merah', 
      'Bukit Panjang', 'Bukit Timah', 'Central Area', 'Choa Chu Kang',
      'Clementi', 'Geylang', 'Hougang', 'Jurong East', 'Jurong West',
      'Kallang/Whampoa', 'Marine Parade', 'Pasir Ris', 'Punggol',
      'Queenstown', 'Sembawang', 'Sengkang', 'Serangoon', 'Tampines',
      'Toa Payoh', 'Woodlands', 'Yishun'] -%}

  <form id="predict_input" method="post">
    <!--Row 1-->
    <div class="row">
      <div class="col-lg-2 mb-3"></div>
      <div class="col-sm mb-3">
        <label for="town" class="form-label">Town</label>
          <select class="form-select" name="town" aria-label=".form-select example" required>
            {% for town in towns %}
            <option value="{{ town }}">{{ town|e }}</option>
            {% endfor %}
          </select>
      </div>
      <div class="col-lg-2 mb-3"></div>
    </div>

    <!--Row 2-->
    <div class="row">
      <div class="col-lg-2"></div>
      <div class="col-sm">
        <label for="floor_area_sqm" class="form-label">Floor area</label>
        <div class="'input-group">
          <input type="number" class="form-control" name="floor_area_sqm" min="20" max="300" required>
          <div class="input-group-append"><span class="input-group-number">sqm</span></div>
        </div>
      </div>

      <div class="col-sm">
        <label for="avg_storey" class="form-label">Storey</label>
        <div class="'input-group mb-3">
          <select class="form-select" name="avg_storey" required>
            <option value="2">1-3</option>
            <option value="5">4-6</option>
            <option value="8">7-9</option>
            <option value="11">10-12</option>
            <option value="14">13-15</option>
            <option value="17">16-18</option>
            <option value="20">19-21</option>
            <option value="23">22-24</option>
            <option value="26">25-27</option>
            <option value="29">28-30</option>
            <option value="32">31-33</option>
            <option value="35">34-36</option>
            <option value="38">37-39</option>
            <option value="41">40-42</option>
            <option value="44">43-45</option>
            <option value="47">46-48</option>
          </select>
        </div>
      </div>

      <div class="col-sm">
        <label for="rooms" class="form-label">Type</label>
        <div class="'input-group mb-3">
          <select class="form-select" name="rooms" aria-label=".form-select-lg example" required>
            <option value="1">1 Room</option>
            <option value="2">2 Room</option>
            <option value="3">3 Room</option>
            <option value="4">4 Room</option>
            <option value="5">5 Room</option>
            <option value="5.5">Executive</option>
            <option value="6">Mansionette</option>
          </select>
        </div>
      </div>

      <div class="col-sm">
          <label for="remaining_lease" class="form-label">Remaining lease</label>
          <div class="'input-group mb-3">
            <input type="number" class="form-control" name="remaining_lease" min="40" max="95" required>
            <span class="input-group-number">years</span>
          </div>
      </div>
      <div class="col-lg-2"></div>
    </div>

    <!--Row 3-->
    <div class="row">
      <div class="col-lg"></div>
      <div class="col-sm-4 mb-5">
        <label for="address" class="form-label">Address / Postcode</label>
        <div class="'input-group">
          <input type="text" class="form-control" name="address" required>
        </div>
      </div>
      <div class="col-lg"></div>
    </div>

    <!--Submit button-->
      <div class="lead mb-3">
        <button type="submit" class="btn btn-lg btn-light fw-bold">Submit</button>
      </div>
  </form>

  <script>
    const form = document.querySelector("#predict_input");

    async function sendData() {
      const formData = new FormData(form); // Associate the FormData object with the form element

      try {
          const response = await fetch("http://natuyuki.pythonanywhere.com/predict", { //"http://127.0.0.1:5000/predict" if local
            method: "POST",
            body: formData, // Set the FormData instance as the request body
            }).then(response => response.json()) 
              .then(data => {    
                var container = document.getElementById('predict_output');
                container.innerHTML = '';
                
                if (data.error_msg == null){
                  // Create the Predicted Price title
                  var strong = document.createElement('strong');
                  strong.textContent = 'Predicted Price';
                  container.appendChild(strong);
                  container.appendChild(document.createElement('br')); // line break

                  // Get the predicted output
                  container.appendChild(document.createTextNode('SGD '));
                  var span = document.createElement('span');
                  span.textContent = data.rounded_prediction;
                  container.appendChild(span);
                }
                else {
                  var strong = document.createElement('strong');
                  strong.textContent = data.error_msg;
                  container.appendChild(strong);
                }
              })
      } 
      catch (e) {
        console.error('Error fetching JSON', e);        
      }
    }

    // Take over form submission
    form.addEventListener("submit", (event) => {
      event.preventDefault();
      sendData();
    });

    ; 

  </script>

  </div>
{% endblock %}